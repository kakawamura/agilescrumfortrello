var AST=AST||{};(function(d){"use strict";$(d).ready(function(){AST=function(A){var appName="Agile SCRUM for Trello boards",appVersion="1.4.3",regexFraction=/\([0-9\.]{1,6}\/[0-9\.]{1,6}\)/,regexFractionDone=/\([0-9\.]{1,6}\//,regexFractionTotal=/\/[0-9\.]{1,6}\)/,regexNumberTotal=/\([0-9\.]{1,5}\)/,regexNumeric=/[0-9\.]+/,regexProjectTag=/\[([\u3400-\uFAFF\u3040-\u30ff\uff65-\uffdca-zA-ZáãàâäéèẽêëíìĩîïóòõôöúùũûüçÁÃÀÂÄÉÈẼÊËÍÌĨÎÏÓÒÕÔÖÚÙŨÛÜÇ0-9 \_\-\.\#]*)\]/g,regexHeader=/>\*{3} .+ \*{3}$/i,regexShortLink=/c\/([^/]+)\/.+/g,storyPointDecimals=1,bodyColor=false,bodyWidth=0,cssStoryPoints="",runTimer=false,runTimerInterval=5e3,runTimerChecksum=0,currentListElement=false,currentListDone=0,currentListTotal=0,currentHeaderElement=false,currentHeaderDone=0,currentHeaderTotal=0,currentCardElement=false,currentCardDone=0,currentCardTotal=0,currentCardTitle=false,currentCardFraction=false;A.init=function(){console.info(appName+" v"+appVersion+" started");_start();_run()};var _start=function(){var cardId=null,cardDetailOpen=null;_run();$(".window-wrapper").bind("DOMSubtreeModified",function(){if(window.location.href.match(regexShortLink)&&!cardDetailOpen){cardId=regexShortLink.exec(window.location.href)[1];regexShortLink.lastIndex=0;cardDetailOpen=true}else if(!window.location.href.match(regexShortLink)&&cardDetailOpen){cardDetailOpen=false;_run()}});runTimer=setInterval(function(){_checkForChanges()},runTimerInterval)};var _checkForChanges=function(){var currentChecksum=$("#board").html().length;if(runTimerChecksum!==currentChecksum){runTimerChecksum=currentChecksum;_run()}};var _run=function(){bodyColor=$("body").css("background-color")&&!$("body").hasClass("body-custom-board-background")?$("body").css("background-color"):"rgb(55, 158, 90)";_removeElements();$("#board").find(".list-cards").each(function(){currentListElement=$(this);currentListElement.find(".list-card").each(function(){currentCardElement=$(this);if(_isCardATextBox(currentCardElement)){return-2}if(!$(currentCardElement).find(".list-card-title").html().match(/<small /g)){currentCardTitle=$(currentCardElement).find(".list-card-title").html();currentCardElement.data("original",currentCardTitle)}else{currentCardTitle=currentCardElement.data("original");$(currentCardElement).find(".list-card-title").html(currentCardTitle)}if(_isCardAHeader(currentCardTitle)){if(currentHeaderTotal>0){_finishHeader()}currentHeaderElement=currentCardElement;currentHeaderElement[0].innerHTML=currentHeaderElement[0].innerHTML.replace(/( ?\*\*\* ?)/g,"");currentHeaderElement.addClass("scrum-card-header")}else if(currentCardTitle.match(regexFraction)){currentCardFraction=currentCardTitle.match(regexFraction)[0];currentCardDone=_getNumber(currentCardFraction.match(regexFractionDone)[0]);currentCardTotal=_getNumber(currentCardFraction.match(regexFractionTotal)[0])}else if(currentCardTitle.match(regexNumberTotal)){currentCardTotal=_getNumber(currentCardTitle.match(regexNumberTotal)[0])}if(currentCardDone==currentCardTotal){cssStoryPoints=" perfect"}else if(currentCardDone>currentCardTotal){cssStoryPoints=" overrun"}else{cssStoryPoints=""}currentCardElement[0].innerHTML=currentCardElement[0].innerHTML.replace(regexNumberTotal,_formatCardPoints);currentCardElement[0].innerHTML=currentCardElement[0].innerHTML.replace(regexFraction,_formatCardPoints);currentCardElement[0].innerHTML=currentCardElement[0].innerHTML.replace(regexProjectTag,_formatCardProjectTag);if(currentCardTotal>0){bodyWidth=currentCardDone/currentCardTotal*100;currentCardElement.prepend('<div class="scrum-card-progress'+cssStoryPoints+'" style="background-color:'+bodyColor+";width:"+(bodyWidth<=100?bodyWidth:100)+'%"></div>');$(currentCardElement[0]).css("font-size",(currentCardTotal<8?90+5*currentCardTotal:130)+"%").css("line-height","1.2em")}currentListDone=currentListDone+currentCardDone;currentListTotal=currentListTotal+currentCardTotal;if(currentHeaderElement){currentHeaderDone=currentHeaderDone+currentCardDone;currentHeaderTotal=currentHeaderTotal+currentCardTotal}currentCardElement=false;currentCardTitle=currentCardFraction="";currentCardTotal=currentCardDone=0});if(currentHeaderTotal>0){_finishHeader()}currentListElement.parent().prepend('<small class="scrum-list-total'+cssStoryPoints+'"><span class="scrum-light">'+currentListDone.toFixed(storyPointDecimals)+"/</span>"+currentListTotal.toFixed(storyPointDecimals)+"</small>");currentListElement=false;currentListDone=currentListTotal=0})};var _removeElements=function(){$(".scrum-list-total,.scrum-list-progress,.scrum-card-progress").remove()};var _isCardATextBox=function(){return currentCardElement.hasClass("js-composer")};var _isCardAHeader=function(title){return title.match(regexHeader)};var _finishHeader=function(){$(currentHeaderElement.find(".list-card-title")[0]).prepend('<small class="scrum-card-points'+(currentHeaderDone>currentHeaderTotal?" overrun":"")+'"><span class="scrum-light">'+currentHeaderDone.toFixed(storyPointDecimals)+"/</span>"+currentHeaderTotal.toFixed(storyPointDecimals)+"</small>");currentHeaderDone=currentHeaderTotal=0};var _getNumber=function(str){return parseFloat(str.match(regexNumeric)[0])};var _formatCardProjectTag=function(match){return'<small class="scrum-card-project" style="background:'+_stringToColor(match)+'">'+match.replace(/\[|\]/g,"").toUpperCase()+"</small>"};var _formatCardPoints=function(match){return'<small class="scrum-card-points'+cssStoryPoints+'">'+match.replace(/\(|\)/g,"").toUpperCase()+"</small>"};var _stringToColor=function(s){var r=0,i=0,len=s.length;s=s.toLowerCase();for(;i<len;i++){r+=s.charAt(i).charCodeAt()*900}return"hsla("+r%256+",50%,40%,1)"};return A}(AST||{});AST.init()})})(document);
